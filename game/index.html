<!DOCTYPE html>
<html lang="pt-br">
    
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Jogo da Memoria</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content=
    "A simple and small HTML5 and CSS3 memory game for kids. Using CSS3 transitions and transforms.">
    <link rel="stylesheet" href="assets/css/alertify.core.css">
    <link rel="stylesheet" href="assets/css/alertify.default.css">
    <link rel="stylesheet" href="assets/css/game.main.css">
    <link rel="stylesheet" href="assets/css/card.css">
    <link rel="stylesheet" href="assets/css/button.css">
  </head>
  
  <body>
    <header id="title" class="site-header">
      <h1 class="title">Jogo da Mem&oacute;ria</h1>    
    </header>
    <progress value="0" max="100">Carregando recursos</progress>
    <section id="game-wrapper"></section>
    <section class="button-container">
      <button id="newgame-button" class="button">Novo Jogo</button>
    </section>
    <footer class="site-footer">
      Desenvolvido por <a href="http://gustavocarvalho.eti.br" class="link">Gustavo Carvalho</a>
    </footer>
    <!--<script src="scripts/alertify.min.js"></script>
    <script src="scripts/ImageManager.js"></script>-->
    <script src="assets/js/memory-0.1.3.js"></script>
    <script>
    (function (global, undefined) {
        "use strict";

        /*var game = new Game({
            rows: 3,
            cols: 4,
            turns: 2,
            show: 4500, // show on init -> 0 means dont show
            showOnError, // time holding the cards face up after a mistake
            front: frontFaces,
            back: backFaces
        });
        game.start();
         */

        // "imports"
        var document = global.document;
        var game = global.game;
        var shuffle = game.utils.shuffle;
        var Card = game.Card; 
        var Board = game.Board;       
        var ImageManager = global.ImageManager;
        
        // settings
        var rows = 3; // number of cards on the y-axis of the game table 
        var cols = 4; // number of cards on the x-axis of the game table 
        var turns = 2; // number of cards equals that makes a score (2)
        var showTime = 2500; // time showing cards at the beginning of the game (4500)
        var transition = 800; // time of all transitions

        // resources
        var frontFaces = [{
                name : "burro",
                tagName : "Burro",
                src : "assets/images/burro.jpg"
            }, {
                name : "cabra",
                tagName : "Cabra",
                src : "assets/images/cabra.jpg"
            }, {
                name : "cao",
                tagName : "C\u00E3o",
                src : "assets/images/cao.jpg"
            }, {
                name : "carneiro",
                tagName : "Carneiro",
                src : "assets/images/carneiro.jpg"
            }, {
                name : "cavalo",
                tagName : "Cavalo",
                src : "assets/images/cavalo.jpg"
            }, {
                name : "cobra",
                tagName : "Cobra",
                src : "assets/images/cobra.jpg"
            }, {
                name : "coelho",
                tagName : "Coelho",
                src : "assets/images/coelho.jpg"
            }, {
                name : "galinha",
                tagName : "Galinha",
                src : "assets/images/galinha.jpg"
            }, {
                name : "gato",
                tagName : "Gato",
                src : "assets/images/gato.jpg"
            }, {
                name : "lagarta",
                tagName : "Lagarta",
                src : "assets/images/lagarta.jpg"
            }, {
                name : "macaco",
                tagName : "Macaco",
                src : "assets/images/macaco.jpg"
            }, {
                name : "porco",
                tagName : "Porco",
                src : "assets/images/porco.jpg"
            }, {
                name : "rato",
                tagName : "Rato",
                src : "assets/images/rato.jpg"
            }, {
                name : "tigre",
                tagName : "Tigre",
                src : "assets/images/tigre.jpg"
            }, {
                name : "vaca",
                tagName : "Vaca",
                src : "assets/images/vaca.jpg"
            }, {
                name : "vacamalhada",
                tagName : "Vaca",
                src : "assets/images/vaca-malhada.jpg"
            }
        ];
        var backFaces = [{
                name : "fundo",
                src : "assets/images/fundo2.jpg"
            }, {
                name : "fundo2",
                src : "assets/images/fundo.jpg"
            }, {
                name : "fundo3",
                src : "assets/images/fundo.jpg"
            }, {
                name : "fundo4",
                src : "assets/images/fundo2.jpg"
            }
        ];

        // main variables
        var i = 0, j = 0; // iterators
        var totalCards = rows * cols; // number of cards in game
        var winCounter = totalCards / turns; // number of correct movements to win the game
        var cards = []; // list of the cards picked for a game
        var canClick = false; // flag to control UI events
        var selections = []; // list of cards correctly selected
        var gameBoard = null; // the game board
        var title = document.getElementById("title"); // title
        var progress = document.querySelector("progress"); // progress bar
        var container = document.getElementById("game-wrapper"); // game container

        // main functions

        function check() {
            // validate the table
            if (totalCards % turns != 0 || turns < 2) {
                game.ui.alert("Ajusta o tabuleiro direito ow!!!");
                throw new Error("Configura\u00E7\u00F5es de tabuleiro inv\u00E1lidas.");
            }
        }

        function preventClicks(time) {
            var waitTime = time + transition + 30;
            // allow user inputs only after the flip animation had finished
            setTimeout(function () {
                canClick = true;
            }, waitTime);
        }

        /**
         * Pick up cards and its back randomly
         */
        function pickupCards() {
            var card;
            shuffle(frontFaces);
            shuffle(backFaces);
            for (i = 0; i < totalCards / turns; i++) {
                for (j = 0; j < turns; j++) { // repeat cards j times
                    card = new Card(frontFaces[i].tagName, frontFaces[i].src, backFaces[0].src);
                    cards.push(card);
                }
            }
        }

        function initGame() {
            check();
            game.dom.removeChilds(title);

            game.ui.log("Memorize as figuras", showTime);
            pickupCards();
            shuffle(cards);
            gameBoard = new Board(container, cards, rows, cols);
            preventClicks(showTime);
            gameBoard.flipAllCards(showTime);
            gameBoard.fadeIn();
            game.events.addEventListener("cellclick", onCellClick);
        }

        function restartGame() {
            game.events.removeEventListener("cellclick", onCellClick);
            winCounter = totalCards / turns;
            cards.length = 0;
            selections.length = 0;
            canClick = false;
            if (gameBoard !== null) {
                gameBoard.destroy();
                gameBoard = null;
            }
            //initGame();
        }

        function gameWin() {
            setTimeout((function () {
                    game.ui.reset();
                    game.ui.alert("Parab&eacute;ns! Jogo conclu&iacute;do!", restartGame);
                }), 1200);
        }

        function onCellClick(e) {
            e.preventDefault();

            var i;
            var movOK = true;
            var thisCard = gameBoard.getCard(e.cell); // get the card

            // this card can be clicked?
            if (!thisCard.hold && !thisCard.done && canClick) { // yes?
                // show the card and select it
                thisCard.flip();
                selections.push(thisCard);

                game.ui.log(thisCard.name, transition);

                // compare selections
                for (i = 1; i < selections.length; i++) {
                    if (selections[i].name !== selections[0].name) {
                        movOK = false; // invalid move
                        break;
                    }
                }

                if (movOK) { // is a valid move?
                    // yes?
                    if (selections.length < turns) { // need more equal cards?
                        // yes?
                        thisCard.block(); // hold this card face up
                    } else { // no? all cards of a type were found

                        // play animations for all selected cards and flag the cards done
                        for (i = 0; i < selections.length; i++) {
                            selections[i].found();
                        }
                        selections.length = 0; // clean selections
                        winCounter--; // compute a right move
                        // check if there is more cards to flip (more movements)
                        if (winCounter === 0) { // no?
                            // so, GG, victory!!!
                            gameWin();
                        }
                    }
                } else { // no? -> invalid move
                    for (i = 0; i < selections.length; i++) {
                        selections[i].release(); // release the cards
                    }
                    canClick = false; // avoid click events to trigger

                    // flip back the selected cards after show the cards for a little while
                    setTimeout(function () {
                        var i;
                        for (i = 0; i < selections.length; i++) {
                            selections[i].flip();
                        }
                        selections.length = 0; // clean selections
                    }, 1500);

                    // allow click events after the flip animation
                    setTimeout(function () {
                        canClick = true;
                    }, 2330);
                }

            }
            return false;
        }

        function openMainMenu() {
            var button = document.querySelector("#newgame-button");
            button.onclick = function (e) {
                restartGame();
                initGame();
                resize();
            }
        }

        function resize() {
            var w = window.innerWidth;
            var h = window.innerHeight;
            var newW = (w - ((cols * cols) * 10)) / cols;
            var newH = (h - ((rows * rows) * 10)) / rows;
            var size = Math.min(newW, newH);

            var cards = document.getElementsByClassName("flip-container");
            var card = null;
            var holder = null;
            var front = null;
            var back = null;
            
            var i;
            
            // resize all necessary divs
            for (i = 0; i < cards.length; i += 1) {
                card = cards.item(i);
                card.style.width = size + "px";
                card.style.height = size + "px";
                holder = card.children[0].children[0].children;
                front = holder[0];
                back = holder[1];
                front.style.width = size + "px";
                front.style.height = size + "px";
                back.style.width = size + "px";
                back.style.height = size + "px";
            }

        }
        //========================================================================================
        // load processes

        function onProgress() {
            var p = ImageManager.getProgress();
            progress.value = p;
        }

        function onComplete() {
            if (ImageManager.hasFinished()) {
                // progress.remove();
                document.body.removeChild(progress);

                openMainMenu();
                //initGame();
            }
        }

        // Pre-load images
        ImageManager.load(frontFaces, onComplete, onProgress);
        ImageManager.load(backFaces, onComplete, onProgress);

        //========================================================================================
        // ui events
              
        // toggle fullscreen on caps-lock
        document.documentElement.addEventListener("keydown", function (e) {
            switch (e.keyCode) {
            case 20: // CapsLock
                e.preventDefault();
                game.ui.toggleFullScreen();
                break;
            }
            return false;
        }, false);

        // auto resize the game table
        window.addEventListener("resize", resize);
        window.addEventListener("orientationchange", resize);

        // get at whatever the global object is, like window in browsers
    })((function () { return this }.call()));
    </script>
  </body>
  
</html>